#!/bin/bash
# 验证三个地方的 agentbox 脚本版本是否一致

set -euo pipefail

# 定义三个文件路径
REPO_FILE="/mnt/volume3/data/repos/github.com/oliveagle/agentbox/agentbox"
SHARE_FILE="${HOME}/.local/share/agentbox/agentbox"
BIN_FILE="${HOME}/.local/bin/agentbox"

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo "========================================"
echo "Agentbox 脚本版本一致性验证"
echo "========================================"
echo

# 检查文件是否存在
check_file() {
    local file="$1"
    local name="$2"
    if [[ -f "$file" ]]; then
        local hash=$(md5sum "$file" 2>/dev/null | cut -d' ' -f1)
        local lines=$(wc -l < "$file")
        echo "✅ $name"
        echo "   路径: $file"
        echo "   MD5:  $hash"
        echo "   行数: $lines"
        return 0
    else
        echo "❌ $name: $file (不存在)"
        return 1
    fi
}

echo "【文件状态】"
echo "----------------------------------------"
REPO_EXISTS=false
SHARE_EXISTS=false
BIN_EXISTS=false

check_file "$REPO_FILE" "代码仓库 " && REPO_EXISTS=true
echo
check_file "$SHARE_FILE" "Share 目录" && SHARE_EXISTS=true
echo
check_file "$BIN_FILE" "Bin 目录 " && BIN_EXISTS=true
echo

# 检查关键内容
echo "【关键内容检查】"
echo "----------------------------------------"
echo "检查项                    代码仓库    Share      Bin"
echo "----------------------    ----------  ---------- ----------"

check_field() {
    local field="$1"
    local pattern="$2"
    local repo_val="N/A"
    local share_val="N/A"
    local bin_val="N/A"

    if [[ "$REPO_EXISTS" == true ]]; then
        if grep -q "$pattern" "$REPO_FILE" 2>/dev/null; then
            repo_val="✅"
        else
            repo_val="❌"
        fi
    fi

    if [[ "$SHARE_EXISTS" == true ]]; then
        if grep -q "$pattern" "$SHARE_FILE" 2>/dev/null; then
            share_val="✅"
        else
            share_val="❌"
        fi
    fi

    if [[ "$BIN_EXISTS" == true ]]; then
        if grep -q "$pattern" "$BIN_FILE" 2>/dev/null; then
            bin_val="✅"
        else
            bin_val="❌"
        fi
    fi

    printf "%-22s    %-10s  %-10s %-10s\n" "$field" "$repo_val" "$share_val" "$bin_val"
}

check_field "CONFIG_FILE 变量" "CONFIG_FILE="
check_field "get_share_dir 函数" "get_share_dir()"
check_field "config.yaml 引用" "config.yaml"
check_field "agents.yaml (旧)" "agents.yaml"
echo

# MD5 对比
echo "【MD5 一致性检查】"
echo "----------------------------------------"

if [[ "$REPO_EXISTS" == true && "$SHARE_EXISTS" == true && "$BIN_EXISTS" == true ]]; then
    REPO_HASH=$(md5sum "$REPO_FILE" | cut -d' ' -f1)
    SHARE_HASH=$(md5sum "$SHARE_FILE" | cut -d' ' -f1)
    BIN_HASH=$(md5sum "$BIN_FILE" | cut -d' ' -f1)

    if [[ "$REPO_HASH" == "$SHARE_HASH" && "$SHARE_HASH" == "$BIN_HASH" ]]; then
        echo -e "${GREEN}✅ 三个文件完全一致${NC}"
        echo "   MD5: $REPO_HASH"
    else
        echo -e "${YELLOW}⚠️ 文件不一致${NC}"
        echo
        echo "MD5 对比:"
        echo "  代码仓库: $REPO_HASH"
        echo "  Share:    $SHARE_HASH"
        echo "  Bin:      $BIN_HASH"
        echo

        if [[ "$REPO_HASH" != "$SHARE_HASH" ]]; then
            echo "❌ 代码仓库 ≠ Share"
        else
            echo "✅ 代码仓库 = Share"
        fi

        if [[ "$SHARE_HASH" != "$BIN_HASH" ]]; then
            echo "❌ Share ≠ Bin"
        else
            echo "✅ Share = Bin"
        fi

        if [[ "$REPO_HASH" != "$BIN_HASH" ]]; then
            echo "❌ 代码仓库 ≠ Bin"
        else
            echo "✅ 代码仓库 = Bin"
        fi
    fi
else
    echo "❌ 有文件缺失，无法对比"
fi

echo

# 修复建议
echo "【修复建议】"
echo "----------------------------------------"

if [[ "$REPO_EXISTS" == true ]]; then
    if [[ "$SHARE_EXISTS" == false || "$BIN_EXISTS" == false ]]; then
        echo "缺失文件，建议运行:"
        echo "  ./install.sh"
    elif [[ "$REPO_HASH" != "$SHARE_HASH" || "$REPO_HASH" != "$BIN_HASH" ]]; then
        echo "版本不一致，建议运行:"
        echo "  ./install.sh"
        echo
        echo "或者手动同步:"
        echo "  cp agentbox ~/.local/share/agentbox/agentbox"
        echo "  cp agentbox ~/.local/bin/agentbox"
        echo "  chmod +x ~/.local/bin/agentbox"
    else
        echo -e "${GREEN}✅ 所有文件版本一致，无需修复${NC}"
    fi
else
    echo "❌ 代码仓库文件不存在"
fi

echo
